<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOT Airdrop Lottery</title>
    <style>
        :root {
            --primary-color: #0088cc;
            --secondary-color: #1e1e2f;
            --accent-color: #ff7b00;
            --text-color: #ffffff;
            --bg-gradient: linear-gradient(135deg, #1e1e2f, #2a2a40);
            --card-bg: rgba(30, 30, 47, 0.7);
            --admin-color: #ff4757;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: var(--bg-gradient);
            color: var(--text-color);
            min-height: 100vh;
            padding-bottom: 60px;
        }

        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        .splash-logo {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #ff9a00, #ff0088);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            font-weight: bold;
            color: white;
            box-shadow: 0 0 30px rgba(255, 0, 136, 0.5);
            animation: pulse 2s infinite, rotate 5s linear infinite;
        }

        .splash-text {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #ff7b00, #ff0088);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(255, 0, 136, 0.3);
        }

        .splash-subtext {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 30px;
        }

        .splash-loading {
            width: 80%;
            max-width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .splash-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), #ff0088);
            width: 0%;
            transition: width 0.3s;
            border-radius: 3px;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 30px rgba(255, 0, 136, 0.5); }
            50% { transform: scale(1.05); box-shadow: 0 0 50px rgba(255, 0, 136, 0.7); }
            100% { transform: scale(1); box-shadow: 0 0 30px rgba(255, 0, 136, 0.5); }
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .app-header {
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .balance-display {
            display: flex;
            gap: 15px;
        }

        .balance-item {
            background: var(--card-bg);
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .connect-wallet {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .connect-wallet:hover {
            opacity: 0.9;
        }

        .connect-wallet.connected {
            background: #4CAF50;
            font-size: 12px;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .game-container {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 18px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-container {
            margin: 15px 0;
        }

        .stage-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .progress-bar {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), #ff0088);
            transition: width 0.3s;
            border-radius: 5px;
        }

        .ticket-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-accent {
            background: linear-gradient(90deg, var(--accent-color), #ff5722);
        }

        .btn-admin {
            background: var(--admin-color);
        }

        .ticket-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 10px;
            color: white;
            width: 80px;
            text-align: center;
        }

        .ticket-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .scratch-card-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .scratch-card {
            width: 150px;
            height: 100px;
            background: linear-gradient(135deg, #ff9a00, #ff0088);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(255, 0, 136, 0.3);
        }

        .scratch-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0088cc, #00cc88);
            opacity: 1;
            transition: opacity 0.5s;
        }

        .scratch-card.scratched::before {
            opacity: 0;
        }

        .scratch-result {
            text-align: center;
            font-size: 16px;
            min-height: 24px;
            margin-top: 10px;
        }

        .referral-link-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .referral-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 10px;
            color: white;
        }

        .price-ticker {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 10px 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }

        .price-ticker::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .price-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 14px;
            white-space: nowrap;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .price-item.up {
            color: #4CAF50;
        }

        .price-item.down {
            color: #ff4757;
        }

        .price-arrow {
            font-size: 12px;
        }

        .app-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 30, 47, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-btn {
            background: none;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }

        .nav-btn.active {
            color: var(--primary-color);
        }

        .result-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .result-modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            max-width: 300px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .result-modal.active .modal-content {
            transform: scale(1);
        }

        .modal-title {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .modal-message {
            margin-bottom: 20px;
        }

        .modal-close {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
        }

        /* Admin Panel Styles */
        .admin-panel {
            display: none;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-section {
            margin-bottom: 20px;
        }

        .admin-section-title {
            font-size: 16px;
            margin-bottom: 10px;
            color: var(--admin-color);
        }

        .admin-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .admin-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .admin-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            flex: 1;
        }

        /* Stages Page */
        .stages-page {
            display: none;
        }

        .stages-page.active {
            display: block;
        }

        .stage-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .stage-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .stage-name {
            font-weight: bold;
            color: var(--accent-color);
        }

        .stage-status {
            font-size: 12px;
            background: rgba(0, 136, 204, 0.2);
            padding: 3px 8px;
            border-radius: 12px;
        }

        .stage-status.active {
            background: rgba(76, 175, 80, 0.2);
        }

        .stage-details {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stage-requirements {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* History Page */
        .history-page {
            display: none;
        }

        .history-page.active {
            display: block;
        }

        .history-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }

        .history-type {
            font-weight: bold;
        }

        .history-win {
            color: #4CAF50;
        }

        .history-loss {
            color: #ff4757;
        }

        /* Exchange Page */
        .exchange-page {
            display: none;
        }

        .exchange-page.active {
            display: block;
        }

        .exchange-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .exchange-rate {
            font-size: 14px;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.7);
        }

        .exchange-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .exchange-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px;
            color: white;
            flex: 1;
        }

        .exchange-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .exchange-preview {
            font-size: 14px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-top: -10px;
        }

        .exchange-fee {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
            display: none; /* Hidden initially as per requirements */
        }

        /* Buy Tickets Section */
        .buy-tickets {
            display: none;
            margin-top: 15px;
        }

        .buy-tickets.active {
            display: block;
        }

        .ticket-purchase-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .ticket-purchase-input {
            flex: 1;
        }

        .daily-limit {
            font-size: 12px;
            margin-top: 10px;
            color: rgba(255, 255, 255, 0.7);
        }

        .pending-exchange {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 136, 204, 0.2);
            border-radius: 12px;
        }

        .pending-exchange.active {
            display: block;
        }

        .countdown-timer {
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            color: var(--accent-color);
        }

        @media (max-width: 480px) {
            .ticket-controls, .ticket-purchase-controls, .exchange-input-group {
                flex-direction: column;
            }
            .ticket-input, .exchange-input {
                width: 100%;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
            .admin-input-group {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="splash-screen" id="splash-screen">
        <div class="splash-logo">LOT</div>
        <div class="splash-text">LOT Airdrop Lottery</div>
        <div class="splash-subtext">Connecting to TON blockchain...</div>
        <div class="splash-loading">
            <div class="splash-progress" id="splash-progress"></div>
        </div>
    </div>

    <div class="app-header">
        <div class="wallet-info">
            <div class="balance-display">
                <div class="balance-item" id="lot-balance">
                    <span>0</span> LOT
                </div>
                <div class="balance-item" id="ticket-count">
                    <span>20</span> Tickets
                </div>
            </div>
            <button class="connect-wallet" id="connect-wallet">
                Connect Wallet
            </button>
        </div>
    </div>

    <div class="price-ticker" id="price-ticker">
        <div class="price-item">
            BTC: $<span id="btc-price">...</span>
            <span class="price-arrow" id="btc-arrow"></span>
        </div>
        <div class="price-item">
            ETH: $<span id="eth-price">...</span>
            <span class="price-arrow" id="eth-arrow"></span>
        </div>
        <div class="price-item">
            BNB: $<span id="bnb-price">...</span>
            <span class="price-arrow" id="bnb-arrow"></span>
        </div>
        <div class="price-item">
            SOL: $<span id="sol-price">...</span>
            <span class="price-arrow" id="sol-arrow"></span>
        </div>
        <div class="price-item">
            TON: $<span id="ton-price">...</span>
            <span class="price-arrow" id="ton-arrow"></span>
        </div>
        <div class="price-item">
            LOT: $<span id="lot-price">0.00016</span>
            <span class="price-arrow" id="lot-arrow"></span>
        </div>
        <!-- Duplicate items to create continuous scrolling effect -->
        <div class="price-item">
            BTC: $<span id="btc-price-2">...</span>
            <span class="price-arrow" id="btc-arrow-2"></span>
        </div>
        <div class="price-item">
            ETH: $<span id="eth-price-2">...</span>
            <span class="price-arrow" id="eth-arrow-2"></span>
        </div>
        <div class="price-item">
            BNB: $<span id="bnb-price-2">...</span>
            <span class="price-arrow" id="bnb-arrow-2"></span>
        </div>
        <div class="price-item">
            SOL: $<span id="sol-price-2">...</span>
            <span class="price-arrow" id="sol-arrow-2"></span>
        </div>
        <div class="price-item">
            TON: $<span id="ton-price-2">...</span>
            <span class="price-arrow" id="ton-arrow-2"></span>
        </div>
        <div class="price-item">
            LOT: $<span id="lot-price-2">0.00016</span>
            <span class="price-arrow" id="lot-arrow-2"></span>
        </div>
    </div>

    <!-- Home Page (Default) -->
    <div class="game-container" id="home-page">
        <div class="section">
            <h2 class="section-title">Current Stage: <span id="current-stage-name">Commoner Draws</span></h2>
            <div class="progress-container">
                <div class="stage-info">
                    <span>Progress</span>
                    <span id="stage-progress">1/16</span>
                </div>
                <div class="progress-bar">
                    <div class="progress" id="stage-progress-bar" style="width: 6.25%"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Participate in Draw</h3>
            <p>Use your tickets to participate in the lottery draw. Each ticket gives you a chance to win 200 LOT!</p>
            <div class="ticket-controls">
                <button class="btn" id="use-one-ticket">Use 1 Ticket</button>
                <input type="number" class="ticket-input" id="bulk-tickets" min="1" max="100" value="5">
                <button class="btn" id="use-multiple-tickets">Use Tickets</button>
            </div>
            <div id="draw-result" class="scratch-result"></div>
            
            <!-- Buy Tickets Section -->
            <div class="buy-tickets" id="buy-tickets">
                <h4>Need more tickets?</h4>
                <p>Buy more tickets using your LOT balance (1 LOT = 1 ticket)</p>
                <div class="ticket-purchase-controls">
                    <input type="number" class="ticket-input ticket-purchase-input" id="tickets-to-buy" min="1" max="100" value="1" placeholder="Number of tickets">
                    <button class="btn btn-accent" id="buy-tickets-btn">Buy Tickets</button>
                </div>
                <div class="daily-limit" id="daily-limit-display">Daily limit: 0/100 tickets purchased</div>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Scratch Cards: <span id="scratch-card-count">0</span></h3>
            <p>Get scratch cards by referring friends. Each card has a 60% chance to win 300-1000 LOT!</p>
            <div class="scratch-card-container">
                <div class="scratch-card" id="scratch-card">
                    <span>Scratch Me!</span>
                </div>
                <div id="scratch-result" class="scratch-result"></div>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Referral Program</h3>
            <p>Refer friends and earn rewards! You need 3 referrals to progress past Stage 3.</p>
            <div class="referral-stats">
                <p>Referrals: <span id="referral-count">0</span>/3</p>
            </div>
            <div class="referral-link-container">
                <input type="text" class="referral-input" id="referral-link" readonly value="Loading...">
                <button class="btn btn-secondary" id="copy-referral">Copy</button>
            </div>
        </div>

        <!-- Admin Panel (Hidden by default) -->
        <div class="admin-panel" id="admin-panel">
            <h3 class="section-title">Admin Controls</h3>
            
            <div class="admin-section">
                <div class="admin-section-title">User Management</div>
                <div class="admin-controls">
                    <div class="admin-input-group">
                        <input type="number" class="admin-input" id="admin-lot-balance" placeholder="Set LOT balance">
                        <button class="btn btn-admin" id="set-lot-balance">Set</button>
                    </div>
                    <div class="admin-input-group">
                        <input type="number" class="admin-input" id="admin-tickets" placeholder="Set tickets">
                        <button class="btn btn-admin" id="set-tickets">Set</button>
                    </div>
                    <div class="admin-input-group">
                        <input type="number" class="admin-input" id="admin-stage" placeholder="Set stage (1-16)" min="1" max="16">
                        <button class="btn btn-admin" id="set-stage">Set</button>
                    </div>
                </div>
            </div>
            
            <div class="admin-section">
                <div class="admin-section-title">Game Settings</div>
                <div class="admin-controls">
                    <div class="admin-input-group">
                        <input type="number" class="admin-input" id="admin-win-rate" placeholder="Base win rate %" step="0.1">
                        <button class="btn btn-admin" id="set-win-rate">Set</button>
                    </div>
                    <div class="admin-input-group">
                        <input type="number" class="admin-input" id="admin-daily-limit" placeholder="Daily ticket limit">
                        <button class="btn btn-admin" id="set-daily-limit">Set</button>
                    </div>
                    <div class="admin-input-group">
                        <input type="number" class="admin-input" id="admin-scratch-win-rate" placeholder="Scratch win rate %" step="0.1">
                        <button class="btn btn-admin" id="set-scratch-win-rate">Set</button>
                    </div>
                </div>
            </div>
            
            <div class="admin-section">
                <div class="admin-section-title">System Controls</div>
                <div class="admin-controls">
                    <button class="btn btn-admin" id="reset-user">Reset User Data</button>
                    <button class="btn btn-admin" id="simulate-win">Simulate Win</button>
                    <button class="btn btn-admin" id="simulate-loss">Simulate Loss</button>
                    <button class="btn btn-admin" id="open-exchange">Open Exchange</button>
                    <button class="btn btn-admin" id="close-exchange">Close Exchange</button>
                    <div class="admin-input-group">
                        <input type="datetime-local" class="admin-input" id="launch-date" placeholder="Set launch date">
                        <button class="btn btn-admin" id="set-launch-date">Set Launch</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stages Page -->
    <div class="game-container stages-page" id="stages-page">
        <div class="section">
            <h2 class="section-title">All Stages</h2>
            <p>Progress through 16 stages with increasing rewards and requirements</p>
            
            <div id="stages-list">
                <!-- Stages will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- History Page -->
    <div class="game-container history-page" id="history-page">
        <div class="section">
            <h2 class="section-title">Your History</h2>
            <p>Record of your recent draws and transactions</p>
            
            <div id="history-list">
                <!-- History items will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Exchange Page -->
    <div class="game-container exchange-page" id="exchange-page">
        <div class="section">
            <h2 class="section-title">Exchange LOT</h2>
            <p id="exchange-status-message">Exchange is currently closed. Please check back later.</p>
            
            <div class="exchange-form">
                <div class="exchange-rate">
                    Current rate: 1 LOT = $<span id="current-lot-price">0.00016</span>
                </div>
                
                <div class="exchange-input-group">
                    <input type="number" class="exchange-input" id="lot-amount" placeholder="LOT amount" disabled>
                    <button class="btn btn-secondary" id="max-lot" disabled>MAX</button>
                </div>
                
                <div class="exchange-input-group">
                    <input type="number" class="exchange-input" id="ton-amount" placeholder="TON amount" readonly>
                </div>
                
                <div id="exchange-preview" class="exchange-preview">
                    You will receive: <span id="exchange-receive">0</span> TON
                    <div class="exchange-fee">Gas fee: $0.5 (â‰ˆ<span id="exchange-fee-ton">0</span> TON)</div>
                </div>
                
                <button class="btn btn-accent" id="exchange-btn" disabled>Exchange</button>
                
                <div class="pending-exchange" id="pending-exchange">
                    <h4>Pending Exchange</h4>
                    <p>You have <span id="pending-lot-amount">0</span> LOT pending exchange.</p>
                    <p>This will be processed during the next exchange window.</p>
                    <div class="countdown-timer" id="countdown-timer"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="result-modal" id="result-modal">
        <div class="modal-content">
            <h3 class="modal-title" id="modal-title">Result</h3>
            <p class="modal-message" id="modal-message"></p>
            <button class="modal-close" id="modal-close">Close</button>
        </div>
    </div>

    <nav class="app-nav">
        <button class="nav-btn active" data-page="home">Home</button>
        <button class="nav-btn" data-page="stages">Stages</button>
        <button class="nav-btn" data-page="history">History</button>
        <button class="nav-btn" data-page="exchange">Exchange</button>
    </nav>

    <script>
        // Game State
        const gameState = {
            lotBalance: 0, // Changed from 12000 to 0 as requested
            tickets: 20,
            scratchCards: 0,
            referrals: 0,
            currentStage: 1,
            dailyTicketUsage: 0,
            dailyTicketsPurchased: 0,
            walletConnected: false,
            walletAddress: '',
            lastScratchTime: 0,
            lastDrawTime: {},
            history: [],
            isAdmin: false, // Set to true to enable admin features
            exchangeOpen: false,
            pendingExchangeAmount: 0,
            launchDate: null, // Will be set by admin
            settings: {
                baseWinRate: 0.6,
                scratchWinRate: 0.6,
                dailyTicketLimit: 100,
                lotPrice: 0.00016, // Changed from 0.00026 to 0.00016 as requested
                exchangeFee: 0.5 // $0.5 exchange fee
            },
            previousPrices: {} // To track price changes
        };

        // Stage Information (All 16 stages)
        const stages = [
            { id: 1, name: "Commoner Draws", frequency: "Hourly", winRate: 0.6, requirements: { lot: 0, tickets: 20, refs: 0 }, reward: 200 },
            { id: 2, name: "Arrival Draws", frequency: "Daily", winRate: 0.25, requirements: { lot: 25000, tickets: 200, refs: 0 }, reward: 500 },
            { id: 3, name: "Settler Draws", frequency: "Every 2 days", winRate: 0.25, requirements: { lot: 50000, tickets: 100, refs: 3 }, reward: 1000 },
            { id: 4, name: "Merchant Draws", frequency: "Every 3 days", winRate: 0.25, requirements: { lot: 100000, tickets: 100, refs: 0 }, reward: 2000 },
            { id: 5, name: "Explorer Draws", frequency: "Every 4 days", winRate: 0.25, requirements: { lot: 200000, tickets: 100, refs: 0 }, reward: 4000 },
            { id: 6, name: "Challenger Draws", frequency: "Every 5 days", winRate: 0.25, requirements: { lot: 400000, tickets: 100, refs: 0 }, reward: 8000 },
            { id: 7, name: "Hero Draws", frequency: "Every 6 days", winRate: 0.25, requirements: { lot: 800000, tickets: 100, refs: 0 }, reward: 16000 },
            { id: 8, name: "Noble Draws", frequency: "Every 7 days", winRate: 0.25, requirements: { lot: 1600000, tickets: 100, refs: 0 }, reward: 32000 },
            { id: 9, name: "Baron Draws", frequency: "Every 8 days", winRate: 0.25, requirements: { lot: 3200000, tickets: 100, refs: 0 }, reward: 64000 },
            { id: 10, name: "Duke Draws", frequency: "Every 9 days", winRate: 0.25, requirements: { lot: 6400000, tickets: 100, refs: 0 }, reward: 128000 },
            { id: 11, name: "Monarch Draws", frequency: "Every 10 days", winRate: 0.25, requirements: { lot: 12800000, tickets: 100, refs: 0 }, reward: 256000 },
            { id: 12, name: "Dynasty Draws", frequency: "Every 11 days", winRate: 0.25, requirements: { lot: 25600000, tickets: 100, refs: 0 }, reward: 512000 },
            { id: 13, name: "Titan Draws", frequency: "Every 12 days", winRate: 0.25, requirements: { lot: 51200000, tickets: 100, refs: 0 }, reward: 1024000 },
            { id: 14, name: "Celestial Draws", frequency: "Every 13 days", winRate: 0.25, requirements: { lot: 102400000, tickets: 100, refs: 0 }, reward: 2048000 },
            { id: 15, name: "Eternal Draws", frequency: "Every 14 days", winRate: 0.25, requirements: { lot: 204800000, tickets: 100, refs: 0 }, reward: 4096000 },
            { id: 16, name: "Legend Draws", frequency: "Every 15 days", winRate: 0.25, requirements: { lot: 409600000, tickets: 100, refs: 0 }, reward: 8192000 }
        ];

        // DOM Elements
        const elements = {
            // Splash screen elements
            splashScreen: document.getElementById('splash-screen'),
            splashProgress: document.getElementById('splash-progress'),
            
            // Balance elements
            lotBalance: document.getElementById('lot-balance').querySelector('span'),
            ticketCount: document.getElementById('ticket-count').querySelector('span'),
            connectWallet: document.getElementById('connect-wallet'),
            
            // Stage elements
            currentStageName: document.getElementById('current-stage-name'),
            stageProgress: document.getElementById('stage-progress'),
            stageProgressBar: document.getElementById('stage-progress-bar'),
            
            // Ticket elements
            useOneTicket: document.getElementById('use-one-ticket'),
            bulkTickets: document.getElementById('bulk-tickets'),
            useMultipleTickets: document.getElementById('use-multiple-tickets'),
            drawResult: document.getElementById('draw-result'),
            buyTicketsSection: document.getElementById('buy-tickets'),
            ticketsToBuy: document.getElementById('tickets-to-buy'),
            buyTicketsBtn: document.getElementById('buy-tickets-btn'),
            dailyLimitDisplay: document.getElementById('daily-limit-display'),
            
            // Scratch card elements
            scratchCardCount: document.getElementById('scratch-card-count'),
            scratchCard: document.getElementById('scratch-card'),
            scratchResult: document.getElementById('scratch-result'),
            
            // Referral elements
            referralCount: document.getElementById('referral-count'),
            referralLink: document.getElementById('referral-link'),
            copyReferral: document.getElementById('copy-referral'),
            
            // Modal elements
            resultModal: document.getElementById('result-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalClose: document.getElementById('modal-close'),
            
            // Price ticker
            priceTicker: {
                btc: document.getElementById('btc-price'),
                eth: document.getElementById('eth-price'),
                bnb: document.getElementById('bnb-price'),
                sol: document.getElementById('sol-price'),
                ton: document.getElementById('ton-price'),
                lot: document.getElementById('lot-price'),
                btc2: document.getElementById('btc-price-2'),
                eth2: document.getElementById('eth-price-2'),
                bnb2: document.getElementById('bnb-price-2'),
                sol2: document.getElementById('sol-price-2'),
                ton2: document.getElementById('ton-price-2'),
                lot2: document.getElementById('lot-price-2'),
                btcArrow: document.getElementById('btc-arrow'),
                ethArrow: document.getElementById('eth-arrow'),
                bnbArrow: document.getElementById('bnb-arrow'),
                solArrow: document.getElementById('sol-arrow'),
                tonArrow: document.getElementById('ton-arrow'),
                lotArrow: document.getElementById('lot-arrow'),
                btcArrow2: document.getElementById('btc-arrow-2'),
                ethArrow2: document.getElementById('eth-arrow-2'),
                bnbArrow2: document.getElementById('bnb-arrow-2'),
                solArrow2: document.getElementById('sol-arrow-2'),
                tonArrow2: document.getElementById('ton-arrow-2'),
                lotArrow2: document.getElementById('lot-arrow-2')
            },
            
            // Page elements
            homePage: document.getElementById('home-page'),
            stagesPage: document.getElementById('stages-page'),
            historyPage: document.getElementById('history-page'),
            exchangePage: document.getElementById('exchange-page'),
            stagesList: document.getElementById('stages-list'),
            historyList: document.getElementById('history-list'),
            
            // Exchange elements
            exchangeStatusMessage: document.getElementById('exchange-status-message'),
            lotAmount: document.getElementById('lot-amount'),
            tonAmount: document.getElementById('ton-amount'),
            maxLot: document.getElementById('max-lot'),
            exchangeBtn: document.getElementById('exchange-btn'),
            currentLotPrice: document.getElementById('current-lot-price'),
            pendingExchange: document.getElementById('pending-exchange'),
            pendingLotAmount: document.getElementById('pending-lot-amount'),
            exchangePreview: document.getElementById('exchange-preview'),
            exchangeReceive: document.getElementById('exchange-receive'),
            exchangeFeeTon: document.getElementById('exchange-fee-ton'),
            countdownTimer: document.getElementById('countdown-timer'),
            
            // Admin elements
            adminPanel: document.getElementById('admin-panel'),
            adminLotBalance: document.getElementById('admin-lot-balance'),
            adminTickets: document.getElementById('admin-tickets'),
            adminStage: document.getElementById('admin-stage'),
            setLotBalance: document.getElementById('set-lot-balance'),
            setTickets: document.getElementById('set-tickets'),
            setStage: document.getElementById('set-stage'),
            adminWinRate: document.getElementById('admin-win-rate'),
            setWinRate: document.getElementById('set-win-rate'),
            adminDailyLimit: document.getElementById('admin-daily-limit'),
            setDailyLimit: document.getElementById('set-daily-limit'),
            adminScratchWinRate: document.getElementById('admin-scratch-win-rate'),
            setScratchWinRate: document.getElementById('set-scratch-win-rate'),
            resetUser: document.getElementById('reset-user'),
            simulateWin: document.getElementById('simulate-win'),
            simulateLoss: document.getElementById('simulate-loss'),
            openExchange: document.getElementById('open-exchange'),
            closeExchange: document.getElementById('close-exchange'),
            launchDateInput: document.getElementById('launch-date'),
            setLaunchDate: document.getElementById('set-launch-date')
        };

        // Initialize the game
        function initGame() {
            // Show splash screen
            showSplashScreen();
            
            // Simulate loading with more realistic progress
            let progress = 0;
            const loadingInterval = setInterval(() => {
                // Simulate different loading speeds for different phases
                if (progress < 30) {
                    progress += Math.random() * 5; // Initial fast progress
                } else if (progress < 70) {
                    progress += Math.random() * 3; // Middle slower progress
                } else {
                    progress += Math.random() * 1; // Final slow progress
                }
                
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(loadingInterval);
                    setTimeout(hideSplashScreen, 500);
                }
                elements.splashProgress.style.width = `${progress}%`;
            }, 200);
            
            // Initialize the rest after splash screen
            setTimeout(() => {
                updateUI();
                setupEventListeners();
                fetchPrices(); // Initial fetch
                setupWebSocketPrices(); // Setup real-time WebSocket connection
                generateReferralLink();
                renderStagesList();
                renderHistoryList();
                startPriceTickerAnimation(); // Start auto-scrolling price ticker
                
                // Check if user is admin (for demo purposes, you would have proper auth in production)
                const urlParams = new URLSearchParams(window.location.search);
                gameState.isAdmin = urlParams.has('admin');
                
                if (gameState.isAdmin) {
                    elements.adminPanel.classList.add('active');
                    // Populate admin controls with current values
                    elements.adminWinRate.value = gameState.settings.baseWinRate * 100;
                    elements.adminScratchWinRate.value = gameState.settings.scratchWinRate * 100;
                    elements.adminDailyLimit.value = gameState.settings.dailyTicketLimit;
                }
                
                // Check if user needs to buy tickets
                checkTicketPurchaseNeeded();
                
                // Update exchange UI
                updateExchangeUI();
                
                // Start countdown timer if launch date is set
                if (gameState.launchDate) {
                    startCountdown();
                }
                
                // Automatically populate LOT amount with full balance when exchange page loads
                elements.maxLot.addEventListener('click', setMaxLot);
                setMaxLot(); // Set max amount immediately
            }, 3000);
        }

        // Auto-scroll price ticker
        function startPriceTickerAnimation() {
            const ticker = elements.priceTicker;
            const container = document.getElementById('price-ticker');
            let scrollPosition = 0;
            
            function scroll() {
                scrollPosition += 0.5; // Adjust speed as needed
                if (scrollPosition >= container.scrollWidth / 2) {
                    scrollPosition = 0;
                }
                container.scrollLeft = scrollPosition;
                requestAnimationFrame(scroll);
            }
            
            requestAnimationFrame(scroll);
        }

        // Show splash screen
        function showSplashScreen() {
            elements.splashScreen.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        // Hide splash screen
        function hideSplashScreen() {
            elements.splashScreen.style.opacity = '0';
            setTimeout(() => {
                elements.splashScreen.style.display = 'none';
                document.body.style.overflow = '';
            }, 500);
        }

        // Update all UI elements based on game state
        function updateUI() {
            // Update balances
            elements.lotBalance.textContent = gameState.lotBalance.toLocaleString();
            elements.ticketCount.textContent = gameState.tickets;
            
            // Update current stage
            const currentStageData = stages[gameState.currentStage - 1];
            elements.currentStageName.textContent = currentStageData.name;
            elements.stageProgress.textContent = `${gameState.currentStage}/16`;
            elements.stageProgressBar.style.width = `${(gameState.currentStage / 16) * 100}%`;
            
            // Update scratch cards
            elements.scratchCardCount.textContent = gameState.scratchCards;
            
            // Update referrals
            elements.referralCount.textContent = gameState.referrals;
            
            // Update ticket controls
            elements.useOneTicket.disabled = gameState.tickets < 1;
            elements.useMultipleTickets.disabled = gameState.tickets < 1;
            elements.bulkTickets.max = Math.min(gameState.tickets, gameState.settings.dailyTicketLimit - gameState.dailyTicketUsage);
            
            // Update daily limit display
            elements.dailyLimitDisplay.textContent = `Daily limit: ${gameState.dailyTicketsPurchased}/${gameState.settings.dailyTicketLimit} tickets purchased`;
            
            // Update wallet connection status
            if (gameState.walletConnected) {
                elements.connectWallet.textContent = `${gameState.walletAddress.slice(0, 6)}...${gameState.walletAddress.slice(-4)}`;
                elements.connectWallet.classList.add('connected');
            } else {
                elements.connectWallet.textContent = 'Connect Wallet';
                elements.connectWallet.classList.remove('connected');
            }
            
            // Check if user can progress to next stage
            checkStageProgression();
            
            // Check if buy tickets section should be shown
            checkTicketPurchaseNeeded();
            
            // Update pending exchange display
            if (gameState.pendingExchangeAmount > 0) {
                elements.pendingLotAmount.textContent = gameState.pendingExchangeAmount.toLocaleString();
                elements.pendingExchange.classList.add('active');
            } else {
                elements.pendingExchange.classList.remove('active');
            }
        }

        // Update exchange UI based on state
        function updateExchangeUI() {
            elements.currentLotPrice.textContent = gameState.settings.lotPrice.toFixed(5);
            elements.lotPrice.textContent = gameState.settings.lotPrice.toFixed(5);
            elements.lotPrice2.textContent = gameState.settings.lotPrice.toFixed(5);
            
            if (gameState.exchangeOpen) {
                elements.exchangeStatusMessage.textContent = "Exchange is open! You can convert your LOT to TON.";
                elements.lotAmount.disabled = !gameState.walletConnected;
                elements.maxLot.disabled = !gameState.walletConnected;
                elements.exchangeBtn.disabled = !gameState.walletConnected;
            } else {
                if (gameState.launchDate) {
                    const now = new Date();
                    if (now < gameState.launchDate) {
                        const hoursRemaining = Math.floor((gameState.launchDate - now) / (1000 * 60 * 60));
                        elements.exchangeStatusMessage.textContent = `Exchange will open in ${hoursRemaining} hours (${gameState.launchDate.toLocaleString()})`;
                    } else {
                        elements.exchangeStatusMessage.textContent = "Exchange is currently closed. Please check back later.";
                    }
                } else {
                    elements.exchangeStatusMessage.textContent = "Exchange is currently closed. Please check back later.";
                }
                elements.lotAmount.disabled = true;
                elements.maxLot.disabled = true;
                elements.exchangeBtn.disabled = true;
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Ticket controls
            elements.useOneTicket.addEventListener('click', () => useTickets(1));
            elements.useMultipleTickets.addEventListener('click', () => {
                const ticketCount = parseInt(elements.bulkTickets.value) || 1;
                useTickets(ticketCount);
            });
            
            // Buy tickets
            elements.buyTicketsBtn.addEventListener('click', buyTickets);
            elements.ticketsToBuy.addEventListener('input', updateTicketPurchasePreview);
            
            // Scratch card
            elements.scratchCard.addEventListener('click', scratchCard);
            
            // Referral
            elements.copyReferral.addEventListener('click', copyReferralLink);
            
            // Modal
            elements.modalClose.addEventListener('click', () => {
                elements.resultModal.classList.remove('active');
            });
            
            // Wallet connection
            elements.connectWallet.addEventListener('click', connectWallet);
            
            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchPage(btn.dataset.page);
                    // Auto-scroll to top when switching pages
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                    // When exchange page is shown, set max LOT amount
                    if (btn.dataset.page === 'exchange') {
                        setMaxLot();
                    }
                });
            });
            
            // Exchange
            elements.lotAmount.addEventListener('input', updateExchangePreview);
            elements.maxLot.addEventListener('click', setMaxLot);
            elements.exchangeBtn.addEventListener('click', exchangeLot);
            
            // Admin controls
            if (gameState.isAdmin) {
                elements.setLotBalance.addEventListener('click', () => {
                    const value = parseInt(elements.adminLotBalance.value);
                    if (!isNaN(value)) {
                        gameState.lotBalance = value;
                        updateUI();
                        addHistoryEntry('Admin', `LOT balance set to ${value}`);
                    }
                });
                
                elements.setTickets.addEventListener('click', () => {
                    const value = parseInt(elements.adminTickets.value);
                    if (!isNaN(value)) {
                        gameState.tickets = value;
                        updateUI();
                        addHistoryEntry('Admin', `Tickets set to ${value}`);
                    }
                });
                
                elements.setStage.addEventListener('click', () => {
                    const value = parseInt(elements.adminStage.value);
                    if (!isNaN(value) && value >= 1 && value <= 16) {
                        gameState.currentStage = value;
                        updateUI();
                        addHistoryEntry('Admin', `Stage set to ${value}`);
                    }
                });
                
                elements.setWinRate.addEventListener('click', () => {
                    const value = parseFloat(elements.adminWinRate.value);
                    if (!isNaN(value) && value >= 0 && value <= 100) {
                        gameState.settings.baseWinRate = value / 100;
                        addHistoryEntry('Admin', `Win rate set to ${value}%`);
                    }
                });
                
                elements.setDailyLimit.addEventListener('click', () => {
                    const value = parseInt(elements.adminDailyLimit.value);
                    if (!isNaN(value) && value > 0) {
                        gameState.settings.dailyTicketLimit = value;
                        addHistoryEntry('Admin', `Daily limit set to ${value}`);
                        updateUI();
                    }
                });
                
                elements.setScratchWinRate.addEventListener('click', () => {
                    const value = parseFloat(elements.adminScratchWinRate.value);
                    if (!isNaN(value) && value >= 0 && value <= 100) {
                        gameState.settings.scratchWinRate = value / 100;
                        addHistoryEntry('Admin', `Scratch win rate set to ${value}%`);
                    }
                });
                
                elements.resetUser.addEventListener('click', () => {
                    if (confirm('Are you sure you want to reset all user data?')) {
                        resetUserData();
                        addHistoryEntry('System', 'User data reset');
                    }
                });
                
                elements.simulateWin.addEventListener('click', () => {
                    gameState.lotBalance += 200;
                    addHistoryEntry('Admin', 'Simulated win (200 LOT)');
                    updateUI();
                });
                
                elements.simulateLoss.addEventListener('click', () => {
                    addHistoryEntry('Admin', 'Simulated loss');
                    updateUI();
                });
                
                elements.openExchange.addEventListener('click', () => {
                    gameState.exchangeOpen = true;
                    updateExchangeUI();
                    addHistoryEntry('Admin', 'Exchange opened');
                    showResultModal('Exchange Opened', 'The LOT to TON exchange is now open!');
                });
                
                elements.closeExchange.addEventListener('click', () => {
                    gameState.exchangeOpen = false;
                    updateExchangeUI();
                    addHistoryEntry('Admin', 'Exchange closed');
                    showResultModal('Exchange Closed', 'The LOT to TON exchange is now closed.');
                });
                
                elements.setLaunchDate.addEventListener('click', () => {
                    const dateString = elements.launchDateInput.value;
                    if (dateString) {
                        gameState.launchDate = new Date(dateString);
                        updateExchangeUI();
                        startCountdown();
                        addHistoryEntry('Admin', `Launch date set to ${gameState.launchDate}`);
                        showResultModal('Launch Date Set', `Exchange will open on ${gameState.launchDate}`);
                    }
                });
            }
        }

        // Start countdown to launch
        function startCountdown() {
            if (!gameState.launchDate) return;
            
            function updateCountdown() {
                const now = new Date();
                const diff = gameState.launchDate - now;
                
                if (diff <= 0) {
                    elements.countdownTimer.textContent = "Launch time reached!";
                    return;
                }
                
                // Calculate days, hours, minutes, seconds
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                elements.countdownTimer.textContent = `Launch in: ${days}d ${hours}h ${minutes}m ${seconds}s`;
                
                // Update every second
                setTimeout(updateCountdown, 1000);
            }
            
            updateCountdown();
        }

        // Use tickets to participate in draw
        function useTickets(ticketCount) {
            if (ticketCount < 1) return;
            
            // Check daily usage limit
            if (gameState.dailyTicketUsage + ticketCount > gameState.settings.dailyTicketLimit) {
                showResultModal('Limit Reached', `You can only use ${gameState.settings.dailyTicketLimit} tickets per day!`);
                return;
            }
            
            // Check if user has enough tickets
            if (gameState.tickets < ticketCount) {
                showResultModal('Not Enough Tickets', `You only have ${gameState.tickets} tickets left!`);
                return;
            }
            
            const currentStage = stages[gameState.currentStage - 1];
            const winRate = currentStage.winRate;
            let wins = 0;
            
            // Simulate each ticket draw
            for (let i = 0; i < ticketCount; i++) {
                if (Math.random() < winRate) {
                    wins++;
                    gameState.lotBalance += currentStage.reward;
                }
            }
            
            // Update game state
            gameState.tickets -= ticketCount;
            gameState.dailyTicketUsage += ticketCount;
            
            // Record history
            const historyEntry = {
                type: 'draw',
                stage: gameState.currentStage,
                ticketsUsed: ticketCount,
                wins: wins,
                timestamp: new Date()
            };
            addHistoryEntry('draw', `Used ${ticketCount} ticket(s) in ${currentStage.name} - ${wins} win(s)`);
            
            // Show result
            const resultMessage = `You used ${ticketCount} ticket(s) and won ${wins} time(s)!`;
            elements.drawResult.textContent = resultMessage;
            
            if (wins > 0) {
                showResultModal('Congratulations!', `You won ${wins * currentStage.reward} LOT from ${ticketCount} tickets!`);
            }
            
            updateUI();
        }

        // Buy tickets with LOT balance
        function buyTickets() {
            const ticketCount = parseInt(elements.ticketsToBuy.value) || 1;
            
            // Check if user has enough LOT
            if (gameState.lotBalance < ticketCount) {
                showResultModal('Not Enough LOT', `You need ${ticketCount} LOT to buy ${ticketCount} tickets!`);
                return;
            }
            
            // Check daily purchase limit
            if (gameState.dailyTicketsPurchased + ticketCount > gameState.settings.dailyTicketLimit) {
                showResultModal('Limit Reached', `You can only buy ${gameState.settings.dailyTicketLimit} tickets per day!`);
                return;
            }
            
            // Process purchase
            gameState.lotBalance -= ticketCount;
            gameState.tickets += ticketCount;
            gameState.dailyTicketsPurchased += ticketCount;
            
            // Record history
            addHistoryEntry('purchase', `Bought ${ticketCount} ticket(s) for ${ticketCount} LOT`);
            
            // Show confirmation
            showResultModal('Tickets Purchased', `You bought ${ticketCount} ticket(s) for ${ticketCount} LOT`);
            
            updateUI();
        }

        // Update ticket purchase preview
        function updateTicketPurchasePreview() {
            const ticketCount = parseInt(elements.ticketsToBuy.value) || 1;
            const cost = ticketCount;
            
            // Validate input
            if (ticketCount < 1) {
                elements.ticketsToBuy.value = 1;
                return;
            }
            
            // Check against daily limit
            const remaining = gameState.settings.dailyTicketLimit - gameState.dailyTicketsPurchased;
            if (ticketCount > remaining) {
                elements.ticketsToBuy.value = remaining;
                return;
            }
            
            // Check against LOT balance
            if (ticketCount > gameState.lotBalance) {
                elements.buyTicketsBtn.disabled = true;
            } else {
                elements.buyTicketsBtn.disabled = false;
            }
        }

        // Check if user needs to buy tickets
        function checkTicketPurchaseNeeded() {
            if (gameState.tickets === 0) {
                elements.buyTicketsSection.classList.add('active');
            } else {
                elements.buyTicketsSection.classList.remove('active');
            }
        }

        // Scratch card function
        function scratchCard() {
            if (gameState.scratchCards < 1) return;
            if (Date.now() - gameState.lastScratchTime < 1000) return; // Prevent rapid clicking
            
            gameState.lastScratchTime = Date.now();
            gameState.scratchCards--;
            
            // Determine win/loss based on win rate
            const isWin = Math.random() < gameState.settings.scratchWinRate;
            let reward = 0;
            
            if (isWin) {
                reward = Math.floor(Math.random() * 701) + 300; // 300-1000 LOT
                gameState.lotBalance += reward;
            }
            
            // Visual effect
            elements.scratchCard.classList.add('scratched');
            
            // Record history
            addHistoryEntry('scratch', isWin ? `Won ${reward} LOT from scratch card` : 'Scratched card - no win');
            
            // Show result
            setTimeout(() => {
                if (isWin) {
                    elements.scratchResult.textContent = `Congratulations! You won ${reward} LOT!`;
                    showResultModal('Scratch Card Win!', `You found ${reward} LOT under the scratch!`);
                } else {
                    elements.scratchResult.textContent = 'Better luck next time!';
                }
                updateUI();
            }, 500);
            
            // Reset scratch card after animation
            setTimeout(() => {
                elements.scratchCard.classList.remove('scratched');
            }, 2000);
        }

        // Generate referral link
        function generateReferralLink() {
            // In a real app, this would use the user's actual ID
            const userId = Math.random().toString(36).substring(2, 10);
            elements.referralLink.value = `https://t.me/lottery_bot?start=ref_${userId}`;
        }

        // Copy referral link
        function copyReferralLink() {
            elements.referralLink.select();
            document.execCommand('copy');
            
            // Show feedback
            const originalText = elements.copyReferral.textContent;
            elements.copyReferral.textContent = 'Copied!';
            setTimeout(() => {
                elements.copyReferral.textContent = originalText;
            }, 2000);
        }

        // Add referral (for demonstration)
        function addReferral() {
            gameState.referrals++;
            gameState.lotBalance += 300;
            gameState.scratchCards += 3;
            
            // Record history
            addHistoryEntry('referral', 'New referral added (+300 LOT, +3 scratch cards)');
            
            // Check if user can progress to next stage
            checkStageProgression();
            
            updateUI();
        }

        // Check if user can progress to next stage
        function checkStageProgression() {
            if (gameState.currentStage >= 16) return;
            
            const nextStage = stages[gameState.currentStage]; // Current stage is 1-based index
            const requirements = nextStage.requirements;
            
            if (gameState.lotBalance >= requirements.lot && 
                gameState.tickets >= requirements.tickets && 
                gameState.referrals >= requirements.refs) {
                
                gameState.currentStage++;
                showResultModal('Stage Unlocked!', `You've unlocked Stage ${gameState.currentStage}: ${nextStage.name}!`);
                addHistoryEntry('progress', `Advanced to Stage ${gameState.currentStage}: ${nextStage.name}`);
                updateUI();
            }
        }

        // Switch between pages
        function switchPage(page) {
            // Hide all pages
            elements.homePage.classList.remove('active');
            elements.stagesPage.classList.remove('active');
            elements.historyPage.classList.remove('active');
            elements.exchangePage.classList.remove('active');
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected page
            switch (page) {
                case 'home':
                    elements.homePage.classList.add('active');
                    document.querySelector('.nav-btn[data-page="home"]').classList.add('active');
                    break;
                case 'stages':
                    elements.stagesPage.classList.add('active');
                    document.querySelector('.nav-btn[data-page="stages"]').classList.add('active');
                    renderStagesList();
                    break;
                case 'history':
                    elements.historyPage.classList.add('active');
                    document.querySelector('.nav-btn[data-page="history"]').classList.add('active');
                    renderHistoryList();
                    break;
                case 'exchange':
                    elements.exchangePage.classList.add('active');
                    document.querySelector('.nav-btn[data-page="exchange"]').classList.add('active');
                    break;
            }
        }

        // Render stages list
        function renderStagesList() {
            elements.stagesList.innerHTML = '';
            
            stages.forEach(stage => {
                const stageCard = document.createElement('div');
                stageCard.className = 'stage-card';
                
                const isCurrent = stage.id === gameState.currentStage;
                const isUnlocked = stage.id <= gameState.currentStage;
                
                stageCard.innerHTML = `
                    <div class="stage-header">
                        <div class="stage-name">Stage ${stage.id}: ${stage.name}</div>
                        <div class="stage-status ${isUnlocked ? 'active' : ''}">
                            ${isCurrent ? 'Current' : isUnlocked ? 'Unlocked' : 'Locked'}
                        </div>
                    </div>
                    <div class="stage-details">
                        <p>Frequency: ${stage.frequency}</p>
                        <p>Win Rate: ${Math.round(stage.winRate * 100)}%</p>
                        <p>Reward: ${stage.reward.toLocaleString()} LOT per win</p>
                    </div>
                    <div class="stage-requirements">
                        Requirements: ${stage.requirements.lot.toLocaleString()} LOT, 
                        ${stage.requirements.tickets} tickets${stage.requirements.refs > 0 ? 
                        `, ${stage.requirements.refs} referrals` : ''}
                    </div>
                `;
                
                elements.stagesList.appendChild(stageCard);
            });
        }

        // Render history list
        function renderHistoryList() {
            elements.historyList.innerHTML = '';
            
            if (gameState.history.length === 0) {
                elements.historyList.innerHTML = '<p>No history yet. Participate in draws to see your history.</p>';
                return;
            }
            
            // Show only the last 20 entries
            const recentHistory = gameState.history.slice(-20).reverse();
            
            recentHistory.forEach(entry => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const isWin = entry.message.includes('Won') || entry.message.includes('win');
                
                historyItem.innerHTML = `
                    <div>
                        <span class="history-type">${entry.type}</span>
                        <span>${entry.message}</span>
                    </div>
                    <div class="${isWin ? 'history-win' : 'history-loss'}">
                        ${formatTime(entry.timestamp)}
                    </div>
                `;
                
                elements.historyList.appendChild(historyItem);
            });
        }

        // Add history entry
        function addHistoryEntry(type, message) {
            gameState.history.push({
                type,
                message,
                timestamp: new Date()
            });
            
            // Keep only the last 100 entries
            if (gameState.history.length > 100) {
                gameState.history.shift();
            }
        }

        // Format time for history
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Show result modal
        function showResultModal(title, message) {
            elements.modalTitle.textContent = title;
            elements.modalMessage.textContent = message;
            elements.resultModal.classList.add('active');
        }

        // Connect wallet (simulated)
        function connectWallet() {
            if (gameState.walletConnected) return;
            
            // Simulate wallet connection
            setTimeout(() => {
                gameState.walletConnected = true;
                gameState.walletAddress = 'EQ' + Math.random().toString(36).substring(2, 34);
                updateUI();
                showResultModal('Wallet Connected', 'Your TON wallet has been successfully connected!');
                addHistoryEntry('wallet', 'TON wallet connected');
                
                // Update exchange UI since it depends on wallet connection
                updateExchangeUI();
            }, 1000);
        }

        // Update exchange preview when LOT amount changes
        function updateExchangePreview() {
            const lotAmount = parseFloat(elements.lotAmount.value) || 0;
            const tonPrice = parseFloat(elements.priceTicker.ton.textContent);
            
            if (lotAmount > 0 && tonPrice > 0) {
                // Calculate TON amount (LOT price in USD / TON price in USD)
                const tonAmount = (lotAmount * gameState.settings.lotPrice) / tonPrice;
                const feeInTon = gameState.settings.exchangeFee / tonPrice;
                
                elements.exchangeReceive.textContent = tonAmount.toFixed(6);
                elements.exchangeFeeTon.textContent = feeInTon.toFixed(6);
                elements.exchangePreview.style.display = 'block';
                
                // Update TON amount field
                elements.tonAmount.value = tonAmount.toFixed(6);
            } else {
                elements.exchangePreview.style.display = 'none';
                elements.tonAmount.value = '';
            }
        }

        // Set max LOT amount
        function setMaxLot() {
            elements.lotAmount.value = gameState.lotBalance;
            updateExchangePreview();
        }

        // Exchange LOT for TON
        function exchangeLot() {
            if (!gameState.exchangeOpen) {
                showResultModal('Exchange Closed', 'The exchange is currently closed. Please try again later.');
                return;
            }
            
            if (!gameState.walletConnected) {
                showResultModal('Wallet Not Connected', 'Please connect your TON wallet first.');
                return;
            }
            
            const lotAmount = parseFloat(elements.lotAmount.value) || 0;
            
            if (lotAmount <= 0) {
                showResultModal('Invalid Amount', 'Please enter a valid LOT amount to exchange.');
                return;
            }
            
            if (lotAmount > gameState.lotBalance) {
                showResultModal('Insufficient Balance', 'You don\'t have enough LOT to exchange this amount.');
                return;
            }
            
            // Calculate TON amount (LOT price in USD / TON price in USD)
            const tonPrice = parseFloat(elements.priceTicker.ton.textContent);
            const tonAmount = (lotAmount * gameState.settings.lotPrice) / tonPrice;
            
            // Move LOT to pending exchange
            gameState.lotBalance -= lotAmount;
            gameState.pendingExchangeAmount += lotAmount;
            
            // Record history
            addHistoryEntry('exchange', `Requested exchange of ${lotAmount} LOT to ~${tonAmount.toFixed(6)} TON (pending)`);
            
            // Show confirmation
            showResultModal('Exchange Requested', 
                `You've requested to exchange ${lotAmount} LOT to approximately ${tonAmount.toFixed(6)} TON.\n\n` +
                `The exchange will be processed during the next exchange window.`);
            
            // Reset form
            elements.lotAmount.value = '';
            elements.tonAmount.value = '';
            elements.exchangePreview.style.display = 'none';
            
            updateUI();
        }

        // Fetch crypto prices from CoinGecko API
        async function fetchPrices() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,binancecoin,solana,the-open-network&vs_currencies=usd');
                const data = await response.json();
                
                updatePriceDisplay('btc', data.bitcoin.usd);
                updatePriceDisplay('eth', data.ethereum.usd);
                updatePriceDisplay('bnb', data.binancecoin.usd);
                updatePriceDisplay('sol', data.solana.usd);
                updatePriceDisplay('ton', data['the-open-network'].usd);
                
                // Update duplicate prices for ticker
                updatePriceDisplay('btc2', data.bitcoin.usd);
                updatePriceDisplay('eth2', data.ethereum.usd);
                updatePriceDisplay('bnb2', data.binancecoin.usd);
                updatePriceDisplay('sol2', data.solana.usd);
                updatePriceDisplay('ton2', data['the-open-network'].usd);
                
                // Update LOT price based on market conditions (simulated)
                // In a real app, this would come from your token's actual market price
                const marketVariation = 0.9 + Math.random() * 0.2; // Random variation between 0.9 and 1.1
                gameState.settings.lotPrice = 0.00016 * marketVariation; // Changed from 0.00026 to 0.00016 as requested
                updatePriceDisplay('lot', gameState.settings.lotPrice);
                updatePriceDisplay('lot2', gameState.settings.lotPrice);
                elements.currentLotPrice.textContent = gameState.settings.lotPrice.toFixed(5);
                
            } catch (error) {
                console.error('Error fetching prices from CoinGecko:', error);
                // Fallback to simulated prices if API fails
                const prices = {
                    btc: (103700 + (Math.random() * 2000 - 1000)).toFixed(2),
                    eth: (3500 + (Math.random() * 200 - 100)).toFixed(2),
                    bnb: (500 + (Math.random() * 20 - 10)).toFixed(2),
                    sol: (150 + (Math.random() * 10 - 5)).toFixed(2),
                    ton: (5 + (Math.random() * 0.5 - 0.25)).toFixed(2)
                };
                
                updatePriceDisplay('btc', prices.btc);
                updatePriceDisplay('eth', prices.eth);
                updatePriceDisplay('bnb', prices.bnb);
                updatePriceDisplay('sol', prices.sol);
                updatePriceDisplay('ton', prices.ton);
                
                // Update duplicate prices for ticker
                updatePriceDisplay('btc2', prices.btc);
                updatePriceDisplay('eth2', prices.eth);
                updatePriceDisplay('bnb2', prices.bnb);
                updatePriceDisplay('sol2', prices.sol);
                updatePriceDisplay('ton2', prices.ton);
                
                // Update LOT price with simulated variation
                const marketVariation = 0.9 + Math.random() * 0.2;
                gameState.settings.lotPrice = 0.00016 * marketVariation; // Changed from 0.00026 to 0.00016 as requested
                updatePriceDisplay('lot', gameState.settings.lotPrice);
                updatePriceDisplay('lot2', gameState.settings.lotPrice);
                elements.currentLotPrice.textContent = gameState.settings.lotPrice.toFixed(5);
            }
            
            // Update prices every 30 seconds
            setTimeout(fetchPrices, 30000);
        }

        // Update price display with animation and arrow indicators
        function updatePriceDisplay(coin, newPrice) {
            const element = elements.priceTicker[coin];
            const arrowElement = elements.priceTicker[`${coin}Arrow`];
            const oldPrice = parseFloat(element.textContent) || 0;
            
            // Format new price
            let formattedPrice;
            if (coin === 'lot' || coin === 'lot2') {
                formattedPrice = parseFloat(newPrice).toFixed(5);
            } else {
                formattedPrice = parseFloat(newPrice).toFixed(2);
            }
            
            // Store previous price for comparison
            if (oldPrice > 0) {
                gameState.previousPrices[coin] = oldPrice;
            }
            
            // Update display
            element.textContent = formattedPrice;
            
            // Add visual indicator if we have previous price
            if (gameState.previousPrices[coin]) {
                const priceElement = element.parentElement;
                priceElement.classList.remove('up', 'down');
                arrowElement.textContent = '';
                
                if (newPrice > gameState.previousPrices[coin]) {
                    priceElement.classList.add('up');
                    arrowElement.textContent = 'â†‘';
                } else if (newPrice < gameState.previousPrices[coin]) {
                    priceElement.classList.add('down');
                    arrowElement.textContent = 'â†“';
                } else {
                    arrowElement.textContent = 'â†’';
                }
                
                // Remove class after animation
                setTimeout(() => {
                    priceElement.classList.remove('up', 'down');
                }, 1000);
            }
        }

        // Setup WebSocket connection for real-time prices (using Binance as example)
        function setupWebSocketPrices() {
            const coins = {
                btc: 'btcusdt',
                eth: 'ethusdt',
                bnb: 'bnbusdt',
                sol: 'solusdt',
                ton: 'tonusdt'
            };
            
            Object.entries(coins).forEach(([coin, pair]) => {
                const ws = new WebSocket(`wss://stream.binance.com:9443/ws/${pair}@ticker`);
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    const price = parseFloat(data.c); // Current price
                    
                    if (coin === 'btc' || coin === 'eth' || coin === 'bnb' || coin === 'sol' || coin === 'ton') {
                        updatePriceDisplay(coin, price);
                        updatePriceDisplay(`${coin}2`, price); // Update duplicate ticker
                    }
                };
                
                ws.onerror = (error) => {
                    console.error(`WebSocket error for ${coin}:`, error);
                };
            });
        }

        // Reset user data
        function resetUserData() {
            gameState.lotBalance = 0; // Changed from 12000 to 0 as requested
            gameState.tickets = 20;
            gameState.scratchCards = 0;
            gameState.referrals = 0;
            gameState.currentStage = 1;
            gameState.dailyTicketUsage = 0;
            gameState.dailyTicketsPurchased = 0;
            gameState.history = [];
            gameState.pendingExchangeAmount = 0;
            
            updateUI();
        }

        // For demo purposes - add a referral when clicking the referral count
        elements.referralCount.addEventListener('click', addReferral);

        // Initialize the game when page loads
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>       
